<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Vodafone Wordsearch — Multiplayer</title>
<style>
  :root{
    --voda:#E60000; --bg:#0c0d10; --panel:#14161a; --muted:#9aa0a6; --grid:#24262b;
    --cell: clamp(24px, 6.2vw, 40px);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .container{max-width:1200px;margin:0 auto;padding:14px}
  .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:12px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:40px;height:40px;border-radius:999px;background:var(--voda);position:relative;overflow:hidden}
  .logo:after{content:"";position:absolute;inset:9px;border:4px solid #fff;border-left-color:transparent;border-bottom-color:transparent;border-radius:50%}
  .title{font-weight:900;font-size:20px}
  .subtitle{color:var(--muted);font-size:12px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{appearance:none;border:1px solid #2a2c31;background:#1a1c20;color:#fff;cursor:pointer;padding:9px 12px;border-radius:12px;font-weight:800}
  .btn-primary{background:var(--voda);border-color:var(--voda)}
  .pill{padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid #2a2c31;background:#121317}

  .row{display:grid;grid-template-columns:1fr 420px;gap:14px}
  @media (max-width:1024px){.row{grid-template-columns:1fr}}

  .card{background:var(--panel);border:1px solid #202226;border-radius:14px;overflow:hidden}
  .card-header{padding:10px 12px;border-bottom:1px solid #202226;display:flex;justify-content:space-between;align-items:center}
  .card-title{font-weight:900}
  .card-content{padding:12px}

  .grid-wrap{display:inline-block;padding:6px;border-radius:12px;border:1px solid #202226;background:#0f1013}
  .grid{display:grid;gap:0;user-select:none;touch-action:none}
  .grid{grid-template-columns: repeat(15, var(--cell));}
  .cell{
    width:var(--cell);height:var(--cell);
    display:flex;align-items:center;justify-content:center;
    background:#0f1115;color:#e9eaed;border-right:1px solid var(--grid);border-bottom:1px solid var(--grid);
    font-weight:900;font-size:calc(var(--cell) * 0.45);cursor:pointer;transition:background .07s,color .07s;
  }
  .cell.sel{background:rgba(230,0,0,.22)}
  .cell.hit{background:rgba(22,163,74,.68)!important;color:#fff!important}
  .cell.miss{background:rgba(220,38,38,.68)!important;color:#fff!important}
  .cell.found{background:var(--voda);color:#fff}

  .list{list-style:none;margin:0;padding:0;display:grid;gap:8px}
  .list li{padding:10px;border:1px solid #202226;border-radius:10px;display:flex;justify-content:space-between;gap:10px;background:#0f1013}
  .list li.found div{opacity:.7;text-decoration:line-through}
  .hint{font-size:12px;color:var(--muted);margin-top:4px}
  .badge{font-size:10px;padding:2px 6px;border-radius:999px;border:1px solid #2a2c31}
  .badge.found{background:#000;border-color:#000}
  .badge.hidden{background:#15171a;color:#ddd}

  .leader{display:grid;gap:8px}
  .leader-row{display:flex;justify-content:space-between;align-items:center;padding:8px;border:1px solid #202226;border-radius:10px;background:#0f1013}

  .bank{display:flex;gap:8px;flex-wrap:wrap;padding:8px;border:1px dashed #2a2c31;border-radius:10px;background:#0b0c0f;min-height:56px}
  .chip{min-width:44px;height:44px;border-radius:10px;border:1px solid #2a2c31;background:#1c1f23;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:20px}
  .chip[draggable=true]{cursor:grab}
  .slots{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
  .slot{width:56px;height:56px;border-radius:10px;border:2px dashed #2a2c31;background:#0b0c0f;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:24px;color:#6b7280}
  .slot.fill{border-style:solid;color:#fff}
  .slots.correct .slot{border-color:#16a34a;background:rgba(21,163,74,.1)}
  .slots.wrong .slot{border-color:#dc2626;background:rgba(220,38,38,.08)}
  @media (max-width:700px){
    .chip{min-width:36px;height:36px;font-size:16px}
    .slot{width:44px;height:44px;font-size:20px}
  }

  /* Winner banner pinned top-right */
  .winner-banner{
    position:fixed; top:12px; right:12px; z-index:40;
    background:var(--voda); color:#fff; font-weight:900; padding:10px 12px; border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,.45);
    display:none; white-space:nowrap; max-width:90vw; overflow:hidden; text-overflow:ellipsis;
  }

  /* QR panel fixed top-left, responsive, smaller on mobile */
  .qr{position:fixed; top:12px; left:12px; z-index:45; background:#fff; color:#111; padding:10px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.45); width:clamp(150px, 26vw, 220px)}
  .qr-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
  .qr-title{display:flex;gap:8px;align-items:center;font-weight:900}
  .qr-icon{width:18px;height:18px;border-radius:4px;background:#111; position:relative}
  .qr-icon:before,.qr-icon:after{content:"";position:absolute}
  .qr-icon:before{inset:3px;border:2px solid var(--voda);border-radius:3px}
  .qr-icon:after{left:50%;top:50%;width:6px;height:6px;background:var(--voda);transform:translate(-50%,-50%);border-radius:1px}
  .qr-sub{font-size:12px;color:#333;margin:6px 0 8px}
  .qr-foot{display:flex;gap:6px;align-items:center;justify-content:space-between}
  .qr .btn{color:#111;background:#f3f4f6;border-color:#e5e7eb;padding:6px 10px;border-radius:8px;font-weight:800}
  .qr .btn-primary{background:var(--voda);border-color:var(--voda);color:#fff}
</style>
</head>
<body>
<div id="winner" class="winner-banner"></div>

<!-- QR fixed top-left -->
<div id="qrPanel" class="qr" role="dialog" aria-label="Scan to join">
  <div class="qr-head">
    <div class="qr-title"><span class="qr-icon" aria-hidden="true"></span> <span>Scan to Join</span></div>
    <button id="qrClose" class="btn">×</button>
  </div>
  <div id="qrcode" style="display:flex;justify-content:center"></div>
  <div class="qr-sub">Point your camera at the code to open the game link.</div>
  <div id="qrCountdown" class="qr-sub" style="font-weight:800">Auto hides in 10s…</div>
  <div class="qr-foot">
    <button id="qrPin" class="btn">Pin</button>
    <button id="qrHide" class="btn btn-primary">Hide</button>
  </div>
</div>

<div class="container" aria-live="polite">
  <div class="topbar">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <div class="title">Vodafone Wordsearch</div>
        <div class="subtitle">Multiplayer • Final Phrase</div>
      </div>
    </div>
    <div class="toolbar">
      <button class="btn" id="btnShuffle">Shuffle</button>
      <button class="btn btn-primary" id="btnStart">Start</button>
      <button class="btn" id="btnStop">Stop</button>
      <button class="btn" id="btnReset">Reset</button>
      <button class="btn" id="btnAddPlayer">Add Player</button>
      <button class="btn" id="btnAddTeam">Add Team</button>
      <span class="pill">Words left: <b id="hudLeft">0</b></span>
      <span class="pill">Time: <b id="hudTime">10:00</b></span>
      <span class="pill">Quickest: <b id="hudBest">--:--</b></span>
    </div>
  </div>

  <div class="row">
    <!-- GRID + LEADERBOARD -->
    <div class="card">
      <div class="card-header"><div class="card-title">Puzzle</div></div>
      <div class="card-content">
        <div class="grid-wrap"><div id="grid" class="grid" aria-label="Wordsearch grid"></div></div>

        <div style="margin-top:16px;font-weight:900">Leaderboard</div>
        <div id="leader" class="leader"></div>

        <div style="margin-top:12px;font-weight:900">Teams</div>
        <div id="teamList" class="leader"></div>

        <div style="margin-top:12px;font-weight:900">Players</div>
        <div id="playerList" class="leader"></div>
      </div>
    </div>

    <!-- FINAL PHRASE + WORDS -->
    <div class="card">
      <div class="card-header"><div class="card-title">Info Panel</div></div>
      <div class="card-content">
        <div style="margin-bottom:16px;">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div style="font-weight:900;">Final Phrase</div>
            <button id="btnClaim" class="btn btn-primary" disabled>Claim Final Phrase</button>
          </div>
          <div style="font-weight:900;margin-top:8px">Letter Bank</div>
          <div id="bank" class="bank"></div>
          <div style="font-weight:900;margin:8px 0">Slots</div>
          <div id="slots" class="slots"></div>
        </div>

        <div style="margin-top:12px;font-weight:900">Words to Find (13)</div>
        <ul id="wordList" class="list"></ul>
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div id="modal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:16px;z-index:60;background:rgba(0,0,0,.5)">
  <div style="width:min(520px,95vw);background:#14161a;border:1px solid #202226;border-radius:12px;overflow:hidden">
    <div style="padding:10px 12px;border-bottom:1px solid #202226;font-weight:900">Assign Score</div>
    <div style="padding:12px;display:grid;gap:10px">
      <div id="modalTitle" style="font-weight:900;font-size:18px"></div>
      <label for="selPlayer">Assign to player</label>
      <select id="selPlayer" style="padding:8px;border-radius:10px;background:#0f1115;border:1px solid #202226;color:#fff"></select>
    </div>
    <div style="padding:10px 12px;border-top:1px solid #202226;display:flex;gap:8px;justify-content:flex-end">
      <button id="btnCancel" class="btn">Cancel</button>
      <button id="btnAssign" class="btn btn-primary">Assign</button>
    </div>
  </div>
</div>

<script>
/* ===== Data ===== */
const SIZE = 15;
const WORDS = [
  {word:"CORE", hint:"Backbone of the network layer that sits beyond access."},
  {word:"SITETRACKER", hint:"The deployment operations tool used for projects, milestones and dashboards."},
  {word:"ALLOCATION", hint:"Assigning specific responsibilities or resources to a deployment task."},
  {word:"NCT", hint:"System used by all regions to allocate sites to INOC (abbr.)."},
  {word:"DELIVERY", hint:"Phase where circuits are provisioned and a site is handed over for live service."},
  {word:"LCA", hint:"Team responsible for setting up pre-build before a site goes live (abbr.)."},
  {word:"CRQ", hint:"Formal change request code used in delivery/go live processes (abbr.)."},
  {word:"AUDIT", hint:"Essential Connectivity Services action to ensure accurate site data before deployment."},
  {word:"TESTING", hint:"Process of verifying a new configuration or service behaves as expected before deployment."},
  {word:"ESCALATION", hint:"Raising a fault or issue to higher-level support or management."},
  {word:"ACHIEVEMENTS", hint:"Successful delivery milestone, e.g., completing a critical task."},
  {word:"METRIC", hint:"Performance indicators tracking rollout speed, resolution time, uptime."},
  {word:"TEAM", hint:"Collaborative group competing on the leaderboard."}
];
const PHRASE = "CSANDLCA";

/* ===== State ===== */
let grid = []; // 2D {letter,found,teamId}
let placed = []; // {word,cells:[{r,c}],foundByPlayerId,foundByTeamId}
let selecting = false, startCell = null, selCells = [];
let players = []; // {id,name,teamId,score}
let teams = [];   // {id,name,color,score}
let bank = [];    // unlocked letters (first letter of each found word)
let slots = Array.from(PHRASE, ch => ch===' ' ? ' ' : '');
let pendingWord = null;
let finalSolved = null;

// timer
let tActive=false, tId=null, remain=600, best=null;

/* ===== Helpers ===== */
const $ = id => document.getElementById(id);
const uid = () => Math.random().toString(36).slice(2,9);
const rnd = n => Math.floor(Math.random()*n);
function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=rnd(i+1); [a[i],a[j]]=[a[j],a[i]];} return a; }
function timeFmt(s){ const m=String(Math.floor(s/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); return `${m}:${ss}`; }
function equalCells(a,b){ return a.length===b.length && a.every((p,i)=>p.r===b[i].r && p.c===b[i].c); }

/* ===== Board ===== */
function newBoard(){
  grid = Array.from({length:SIZE}, ()=>Array.from({length:SIZE}, ()=>({letter:'',found:false,teamId:null})));
  placed = [];
  WORDS.forEach(w=>placeWord(w.word));
  for(let r=0;r<SIZE;r++) for(let c=0;c<SIZE;c++) if(!grid[r][c].letter) grid[r][c].letter = String.fromCharCode(65+rnd(26));
  renderBoard(); renderWords(); updateHUD();
}
function placeWord(word){
  const dirs = [[0,1],[1,0],[1,1],[1,-1],[0,-1],[-1,0],[-1,-1],[-1,1]];
  for(let k=0;k<1200;k++){
    const [dr,dc]=dirs[rnd(dirs.length)], r0=rnd(SIZE), c0=rnd(SIZE);
    const cells=[]; let ok=true;
    for(let i=0;i<word.length;i++){
      const r=r0+dr*i,c=c0+dc*i;
      if(r<0||c<0||r>=SIZE||c>=SIZE){ok=false;break;}
      const cell=grid[r][c];
      if(cell.letter && cell.letter!==word[i]){ok=false;break;}
      cells.push({r,c});
    }
    if(ok){
      cells.forEach((p,i)=>grid[p.r][p.c].letter=word[i]);
      placed.push({word,cells,foundByPlayerId:null,foundByTeamId:null});
      return true;
    }
  }
  return false;
}

/* ===== Render ===== */
function renderBoard(){
  const g=$("grid"); g.innerHTML="";
  for(let r=0;r<SIZE;r++){
    for(let c=0;c<SIZE;c++){
      const d=document.createElement("div");
      d.className="cell"; d.dataset.r=r; d.dataset.c=c; d.textContent=grid[r][c].letter;
      if(grid[r][c].found) d.classList.add("found");
      g.appendChild(d);
    }
  }
}
function renderWords(){
  const ul=$("wordList"); ul.innerHTML="";
  const order=[...placed].sort((a,b)=>{
    const af=!!a.foundByPlayerId, bf=!!b.foundByPlayerId;
    if(af!==bf) return af?1:-1;
    return a.word.localeCompare(b.word);
  });
  order.forEach(w=>{
    const li=document.createElement("li");
    if(w.foundByPlayerId) li.classList.add("found");
    const left=document.createElement("div");
    const info=WORDS.find(x=>x.word===w.word);
    left.innerHTML = `<div style="font-weight:900">${w.word}</div><div class="hint">${info?.hint||""}</div>`;
    const right=document.createElement("div");
    right.innerHTML=`<span class="badge ${w.foundByPlayerId?'found':'hidden'}">${w.foundByPlayerId?'Found':'Hidden'}</span>`;
    li.appendChild(left); li.appendChild(right); ul.appendChild(li);
  });
}
function renderPlayers(){
  const c=$("playerList"); c.innerHTML="";
  players.forEach(p=>{
    const t=teams.find(x=>x.id===p.teamId);
    const row=document.createElement("div"); row.className="leader-row";
    row.innerHTML=`<div>${p.name||'Player'} <span style="color:${t?.color||'#9aa0a6'}">${t?.name||'No Team'}</span></div><div>${p.score}</div>`;
    c.appendChild(row);
  });
}
function renderTeams(){
  const c=$("teamList"); c.innerHTML="";
  teams.forEach(t=>{
    const row=document.createElement("div"); row.className="leader-row";
    row.innerHTML=`<div><span style="display:inline-block;width:10px;height:10px;background:${t.color};border-radius:999px;margin-right:8px"></span>${t.name}</div><div>${t.score}</div>`;
    c.appendChild(row);
  });
}
function renderLeader(){
  const L=$("leader"); L.innerHTML="";
  if(players.length===0){ const r=document.createElement("div"); r.className="leader-row"; r.innerHTML="<div>No teams yet 🏆</div><div>0</div>"; L.appendChild(r); return; }
  const ranking=[...players].sort((a,b)=>b.score-a.score);
  ranking.forEach((p,i)=>{
    const t=teams.find(x=>x.id===p.teamId);
    const r=document.createElement("div"); r.className="leader-row";
    r.innerHTML=`<div><b>${i+1}.</b> ${p.name} — ${t?.name||'No Team'}</div><div>${p.score}</div>`;
    L.appendChild(r);
  });
}
function updateHUD(){
  $("hudLeft").textContent = placed.filter(w=>!w.foundByPlayerId).length;
  $("hudTime").textContent = timeFmt(remain);
  $("hudBest").textContent = best==null ? "--:--" : timeFmt(best);
}

/* ===== Selection ===== */
function elAt(e){ const t=e.target.closest(".cell"); if(!t) return null; return {r:+t.dataset.r,c:+t.dataset.c,el:t}; }
function cellsLine(sr,sc,er,ec){
  const dr=Math.sign(er-sr), dc=Math.sign(ec-sc);
  if(!(dr===0||dc===0||Math.abs(er-sr)===Math.abs(ec-sc))) return [];
  const len=Math.max(Math.abs(er-sr),Math.abs(ec-sc))+1;
  const a=[]; for(let i=0;i<len;i++) a.push({r:sr+i*dr,c:sc+i*dc}); return a;
}
function highlight(){ document.querySelectorAll(".cell.sel").forEach(x=>x.classList.remove("sel")); selCells.forEach(p=>document.querySelector(`.cell[data-r="${p.r}"][data-c="${p.c}"]`)?.classList.add("sel")); }
function flash(kind){ selCells.forEach(p=>{const el=document.querySelector(`.cell[data-r="${p.r}"][data-c="${p.c}"]`); el.classList.add(kind); setTimeout(()=>el.classList.remove(kind),340);}); }

function startSel(e){ const p=elAt(e); if(!p) return; selecting=true; startCell=p; selCells=[{r:p.r,c:p.c}]; highlight(); }
function moveSel(e){ if(!selecting) return; const p=elAt(e); if(!p) return; selCells=cellsLine(startCell.r,startCell.c,p.r,p.c); highlight(); }
function endSel(){
  if(!selecting) return;
  selecting=false;
  const letters = selCells.map(p=>grid[p.r][p.c].letter).join("");
  const rev = letters.split("").reverse().join("");
  const match = placed.find(w=>!w.foundByPlayerId && (w.word===letters || w.word===rev || equalCells(selCells,w.cells) || equalCells(selCells.slice().reverse(), w.cells)));
  if(match){ flash("hit"); setTimeout(()=>{ pendingWord=match; openModal("WORD: "+match.word); },320); }
  else{ flash("miss"); }
  document.querySelectorAll(".cell.sel").forEach(x=>x.classList.remove("sel"));
  selCells=[];
}

/* Mouse */
$("grid").addEventListener("mousedown", startSel);
window.addEventListener("mousemove", moveSel);
window.addEventListener("mouseup", endSel);
/* Touch */
$("grid").addEventListener("touchstart", e=>{ e.preventDefault(); startSel(e.touches[0]); }, {passive:false});
$("grid").addEventListener("touchmove", e=>{ e.preventDefault(); moveSel(e.touches[0]); }, {passive:false});
window.addEventListener("touchend", ()=>endSel());

/* ===== Modal assign ===== */
function openModal(title){
  if(players.length===0){ alert("Add at least one player first to assign the score."); return; }
  $("modalTitle").textContent=title;
  const sel=$("selPlayer"); sel.innerHTML="";
  players.forEach(p=>{
    const t=teams.find(x=>x.id===p.teamId);
    const opt=document.createElement("option");
    opt.value=p.id; opt.textContent=`${p.name} (${t?.name||'No Team'})`;
    sel.appendChild(opt);
  });
  $("modal").style.display="flex";
}
$("btnCancel").onclick=()=>{ $("modal").style.display="none"; pendingWord=null; };

$("btnAssign").onclick=()=>{
  const pid=$("selPlayer").value;
  if(pendingWord){
    // mark cells
    pendingWord.cells.forEach(({r,c})=>{ grid[r][c].found=true; grid[r][c].teamId = players.find(p=>p.id===pid)?.teamId || null; });
    // scoring
    const pts=pendingWord.word.length;
    const P=players.find(p=>p.id===pid); if(P) P.score+=pts;
    const T=teams.find(t=>t.id===P.teamId); if(T) T.score+=pts;
    // unlock first letter into bank
    bank.push(pendingWord.word[0]); shuffle(bank);
    pendingWord.foundByPlayerId=pid; pendingWord.foundByTeamId=P.teamId || null;
    pendingWord=null;
    renderBoard(); renderWords(); renderPlayers(); renderTeams(); renderLeader(); updateHUD();
    renderBank(); updateClaimBtn();
    checkDone();
  } else {
    // final phrase assignment
    const attempt = slots.join("");
    const ok = attempt === PHRASE;
    const P=players.find(p=>p.id===pid); const T=teams.find(t=>t.id===(P?.teamId||null));
    if(ok){
      finalSolved={byPlayerId:P?.id||null, byTeamId:T?.id||null};
      if(P) P.score+=20; if(T) T.score+=20;
      $("slots").classList.add("correct");
      showWinner();
      checkDone();
    }else{
      $("slots").classList.add("wrong");
      setTimeout(()=>$("slots").classList.remove("wrong"),600);
    }
    renderPlayers(); renderTeams(); renderLeader(); updateClaimBtn();
  }
  $("modal").style.display="none";
};

/* ===== Final Phrase drag/drop ===== */
function renderBank(){
  const b=$("bank"); b.innerHTML="";
  bank.forEach((ch,i)=>{
    const d=document.createElement("div"); d.className="chip"; d.textContent=ch; d.draggable=true;
    d.addEventListener("dragstart", e=>{ e.dataTransfer.setData("text/plain","b:"+i); });
    b.appendChild(d);
  });
}
function renderSlots(){
  const s=$("slots"); s.innerHTML="";
  Array.from(PHRASE).forEach((ch,i)=>{
    const d=document.createElement("div"); d.className="slot"+(slots[i]?" fill":""); d.dataset.i=i; d.textContent = slots[i]||"";
    d.addEventListener("dragover", e=>e.preventDefault());
    d.addEventListener("drop", e=>{
      e.preventDefault();
      const data=e.dataTransfer.getData("text/plain"); if(!data) return;
      if(data.startsWith("b:")){
        const bi=+data.split(":")[1]; const ch=bank[bi]; if(!ch) return;
        slots[i]=ch; bank.splice(bi,1);
        renderSlots(); renderBank(); updateClaimBtn();
      }else if(data.startsWith("s:")){
        const from=+data.split(":")[1]; const tmp=slots[from]; slots[from]=slots[i]; slots[i]=tmp; renderSlots(); updateClaimBtn();
      }
    });
    d.draggable=!!slots[i];
    d.addEventListener("dragstart", e=>{ e.dataTransfer.setData("text/plain","s:"+i); });
    s.appendChild(d);
  });
}
function updateClaimBtn(){
  const ready = slots.length===PHRASE.length && slots.every((ch,i)=>!!ch || PHRASE[i]===' ');
  $("btnClaim").disabled = !ready || !!finalSolved;
}
$("btnClaim").onclick=()=>{
  // flash correctness on each slot, then open modal to assign final
  const elems=[...document.querySelectorAll("#slots .slot")];
  elems.forEach((el,i)=>{
    const val=slots[i], ok = val===PHRASE[i];
    el.classList.add(ok?"hit":"miss");
    setTimeout(()=>el.classList.remove(ok?"hit":"miss"),320);
  });
  setTimeout(()=>{
    if(players.length===0){ alert("Add at least one player first to assign the score."); return; }
    openModal("FINAL PHRASE: "+PHRASE);
  },320);
};

/* ===== Players & Teams ===== */
$("btnAddTeam").onclick=()=>{
  const name=prompt("Team name:"); if(!name) return;
  const color=prompt("Team colour (CSS/hex):", "#"+Math.random().toString(16).slice(2,8));
  teams.push({id:uid(), name, color:color||"#E60000", score:0});
  renderTeams(); renderLeader();
};
$("btnAddPlayer").onclick=()=>{
  const name=prompt("Player name:"); if(!name) return;
  let teamId=null;
  if(teams.length){
    const menu=teams.map((t,i)=>`${i+1}. ${t.name}`).join("\n");
    const pick=prompt(`Assign to team? Enter number or leave blank:\n${menu}`);
    const idx=(+pick|0)-1; if(teams[idx]) teamId=teams[idx].id;
  }
  players.push({id:uid(), name, teamId, score:0});
  renderPlayers(); renderLeader();
};

/* ===== Timer ===== */
function startTimer(){
  clearInterval(tId); remain=600; tActive=true; $("hudTime").textContent=timeFmt(remain);
  tId=setInterval(()=>{ remain--; $("hudTime").textContent=timeFmt(remain); if(remain<=0){ clearInterval(tId); tActive=false; alert("⏱ Time's up!"); } },1000);
}
function stopTimer(){
  if(!tActive){ alert("Timer is not running."); return; }
  clearInterval(tId); tActive=false;
  if(isComplete()){
    const elapsed=600-remain; if(best==null || elapsed<best) best=elapsed;
    $("hudBest").textContent=timeFmt(best);
    alert(`Stopped. Finish time: ${timeFmt(elapsed)} (Best: ${timeFmt(best)})`);
  }else{
    alert("Stopped. Round not finished yet.");
  }
}
function resetAll(){
  clearInterval(tId); tActive=false; remain=600; $("hudTime").textContent=timeFmt(remain);
  // reset scores & state
  bank=[]; slots=Array.from(PHRASE, ch=>ch===' ' ? ' ' : ''); finalSolved=null;
  players.forEach(p=>p.score=0); teams.forEach(t=>t.score=0);
  newBoard(); renderBank(); renderSlots(); renderPlayers(); renderTeams(); renderLeader(); renderWords(); updateHUD();
  hideWinner();
}
$("btnStart").onclick=startTimer;
$("btnStop").onclick=stopTimer;
$("btnReset").onclick=resetAll;
$("btnShuffle").onclick=()=>{ newBoard(); };

/* ===== End & Winner ===== */
function isComplete(){ return placed.every(w=>w.foundByPlayerId) && !!finalSolved; }
function showWinner(){
  const topP=[...players].sort((a,b)=>b.score-a.score)[0];
  const topT=[...teams].sort((a,b)=>b.score-a.score)[0];
  const elapsed=600-remain;
  const banner=$("winner");
  banner.textContent=`🏁 Finished in ${timeFmt(elapsed)} — Player: ${topP?.name||'n/a'} (${topP?.score||0} pts) · Team: ${topT?.name||'n/a'} (${topT?.score||0} pts)`;
  banner.style.display="inline-flex";
  if(best==null || elapsed<best){ best=elapsed; $("hudBest").textContent=timeFmt(best); }
}
function hideWinner(){ $("winner").style.display="none"; }
function checkDone(){ if(isComplete()){ clearInterval(tId); tActive=false; showWinner(); } }

/* ===== QR (fixed, responsive, auto-hide 10s, pin/hide, tap-to-hide) ===== */
function buildQR(){
  const target=$("qrcode"); target.innerHTML="";
  const url=location.href;
  if(window.QRCode){
    new QRCode(target,{text:url,width:Math.round(target.clientWidth||160),height:Math.round(target.clientWidth||160),
      colorDark:"#111",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H});
  }else{
    const c=document.createElement("canvas"); c.width=160; c.height=160;
    const ctx=c.getContext("2d"); ctx.fillStyle="#111"; ctx.fillRect(0,0,160,160); ctx.fillStyle="#fff"; ctx.fillRect(20,20,120,120);
    target.appendChild(c);
  }
}
let qrPinned=false, qrLeft=10, qrTick=null;
function startQrCountdown(){
  clearInterval(qrTick);
  qrTick=setInterval(()=>{ if(qrPinned) return; qrLeft--; $("qrCountdown").textContent = qrLeft>0?`Auto hides in ${qrLeft}s…`:"Hiding…";
    if(qrLeft<=0){ clearInterval(qrTick); hideQR(); }},1000);
}
function hideQR(){ $("qrPanel").style.display="none"; localStorage.setItem("qrHidden","1"); }
function showQR(){ $("qrPanel").style.display="block"; localStorage.removeItem("qrHidden"); qrLeft=10; $("qrCountdown").textContent=`Auto hides in ${qrLeft}s…`; startQrCountdown(); }

$("qrPin").onclick=()=>{ qrPinned=!qrPinned; $("qrPin").textContent = qrPinned? "Unpin":"Pin"; $("qrCountdown").textContent = qrPinned? "Pinned — won't auto hide" : `Auto hides in ${qrLeft}s…`; };
$("qrHide").onclick=hideQR;
$("qrClose").onclick=hideQR;
// Tap/click QR itself to hide (simulates “scanned”)
$("qrcode").addEventListener("click", hideQR);
window.addEventListener("resize", ()=>buildQR());

/* ===== Boot ===== */
function boot(){
  newBoard(); renderSlots(); renderBank(); renderPlayers(); renderTeams(); renderLeader(); updateHUD();
  // QR
  buildQR();
  if(localStorage.getItem("qrHidden")==="1"){ $("qrPanel").style.display="none"; }
  else{ startQrCountdown(); }
}
boot();
</script>
<!-- QR code library (optional, for crisp codes) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" crossorigin="anonymous"></script>
</body>
</html>
