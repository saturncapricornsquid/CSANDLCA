<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Vodafone Wordsearch — 15×15 • Multiplayer • Seeded</title>
<style>
  :root{
    --voda-red:#E60000; --bg:#0c0d10; --panel:#14161a; --muted:#9aa0a6;
    --grid:#2b2e33; --good:#16a34a; --bad:#dc2626; --chip:#1f2226;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .container{max-width:1240px;margin:0 auto;padding:16px}
  .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:12px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:40px;height:40px;border-radius:999px;background:var(--voda-red)}
  .title{font-weight:900;font-size:22px}
  .subtitle{color:var(--muted);font-size:13px}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{appearance:none;border:1px solid #2a2c31;background:#1a1c20;color:#fff;cursor:pointer;padding:9px 12px;border-radius:12px;font-weight:800}
  .btn-primary{background:var(--voda-red);border-color:var(--voda-red)}
  .btn-ghost{background:#15171a}
  .btn:disabled{opacity:.5;cursor:default}
  .pill{padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid #2a2c31;background:#121317}
  .pill-ghost{background:#0d0f12;border-color:#1e2126;color:#cbd5e1}
  .row{display:grid;grid-template-columns:1fr 460px;gap:16px}
  @media (max-width:1100px){.row{grid-template-columns:1fr}}

  .card{background:var(--panel);border:1px solid #24262b;border-radius:14px}
  .card-header{padding:12px 14px;display:flex;align-items:center;justify-content:space-between}
  .card-title{font-weight:800}
  .card-content{padding:12px 14px 14px}

  .grid-wrap{display:inline-block;padding:8px;border-radius:12px;border:1px solid #24262b;background:#0f1013}
  .grid{display:grid;gap:0;user-select:none;touch-action:none;background:var(--grid)}
  .cell{width:44px;height:44px;display:flex;align-items:center;justify-content:center;
        font-weight:900;font-size:18px;color:#e9eaed;background:#101217;
        border-right:1px solid #24262b;border-bottom:1px solid #24262b;cursor:pointer;
        transition:background .08s,color .08s;}
  .cell.top{border-top:1px solid #24262b}
  .cell.sel{background:rgba(230,0,0,.22)}
  .cell.hit, .slot.hit{background:rgba(22,163,74,.65)!important;color:#fff!important}
  .cell.miss, .slot.miss{background:rgba(220,38,38,.65)!important;color:#fff!important}
  .cell.found{background:var(--voda-red);color:#fff}

  .list{list-style:none;margin:0;padding:0;display:grid;gap:8px}
  .list li{padding:10px;border:1px solid #24262b;border-radius:12px;display:flex;justify-content:space-between;gap:12px;align-items:start;background:#0f1013}
  .list li.found div{color:var(--muted);text-decoration:line-through}
  .hint{font-size:12px;color:var(--muted);margin-top:4px}
  .badge{font-size:10px;padding:2px 6px;border-radius:999px;border:1px solid #2a2c31}
  .badge.found{background:#000;color:#fff;border-color:#000}
  .badge.hidden{background:#15171a;color:#ddd}
  .stack{display:grid;gap:8px}

  .bank{display:flex;gap:8px;flex-wrap:wrap;padding:8px;border:1px dashed #2a2c31;border-radius:10px;background:#0c0d10;min-height:56px}
  .chip{min-width:44px;height:44px;border-radius:10px;border:1px solid #2a2c31;background:var(--chip);
        display:flex;align-items:center;justify-content:center;font-weight:900;font-size:20px}
  .chip[draggable=true]{cursor:grab}
  .slots{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
  .slot{width:56px;height:56px;border-radius:10px;border:2px dashed #2a2c31;background:#0b0c0f;
        display:flex;align-items:center;justify-content:center;font-weight:900;font-size:24px;color:#6b7280}
  .slot.fill{border-style:solid;color:#fff}
  .slots.correct .slot{border-color:#16a34a;background:rgba(21,163,74,.1)}
  .slots.wrong .slot{border-color:#dc2626;background:rgba(220,38,38,.08)}

  .leader{display:grid;gap:8px}
  .leader-row{display:flex;justify-content:space-between;align-items:center;padding:8px;border:1px solid #2a2c31;border-radius:10px;background:#0f1013}

  /* Winner banner */
  #winnerBanner{display:none;background:#E60000;color:white;font-weight:900;font-size:18px;padding:10px;text-align:center;border-radius:10px;margin-bottom:10px}

  /* HUD winners (mini status) */
  #hudWinners{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  #hudWinners .pill{white-space:nowrap}

  /* QR panel (top-left, compact) */
  #qrPanel{position:fixed;top:10px;left:10px;z-index:999;background:#ffffff;color:#111;padding:8px 10px;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.28);display:flex;align-items:center;gap:8px}
  #qrIcon{width:28px;height:28px;border-radius:6px;background:var(--voda-red);display:flex;align-items:center;justify-content:center}
  #qrIcon svg{width:18px;height:18px;fill:#fff}
  #qrcode{width:110px;height:110px}
  #qrLabel{font-size:12px;color:#444;text-align:center}

  /* Modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
  .modal{width:min(520px,95vw);background:#14161a;border:1px solid #2a2c31;border-radius:14px;box-shadow:0 20px 60px rgba(0,0,0,.5)}
  .modal .head{padding:12px 14px;border-bottom:1px solid #222;color:#fff;font-weight:900}
  .modal .body{padding:12px 14px;display:grid;gap:10px}
  .modal .foot{padding:12px 14px;border-top:1px solid #222;display:flex;gap:8px;justify-content:flex-end}

  @media (max-width: 768px) {
    #qrPanel{display:none!important;}
    .cell{width:32px;height:32px;font-size:16px}
  }
</style>
</head>
<body>

<!-- Compact QR with phone+QR icon and “Scan me” label -->
<div id="qrPanel" aria-label="Scan to open game">
  <div id="qrIcon" title="QR">
    <!-- phone+qr glyph (different from the previous QR icon) -->
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M7 2h10a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2zm0 2v16h10V4H7zm2 1h6v8H9V5zm1 1v6h4V6h-4zM9 16h2v2H9v-2zm4 0h2v2h-2v-2z"></path>
    </svg>
  </div>
  <div>
    <div id="qrcode" aria-hidden="true"></div>
    <div id="qrLabel">Scan me</div>
  </div>
</div>

<div class="container">
  <div id="winnerBanner"></div>

  <div class="topbar">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <div class="title">Vodafone Wordsearch</div>
        <div class="subtitle" id="subtitleSeed">Multiplayer • 15×15 grid</div>
      </div>
    </div>
    <div class="toolbar">
      <button class="btn btn-ghost" id="btnShuffle" title="New shared layout (new seed)">Shuffle</button>
      <button class="btn btn-primary" id="btnStart">Start</button>
      <button class="btn" id="btnStop">Stop</button>
      <button class="btn" id="btnReset" title="Reset scores & board (same seed)">Reset</button>
      <button class="btn" id="btnNewPlayer">Add Player</button>
      <button class="btn" id="btnNewTeam">Add Team</button>
      <button class="btn" id="btnShare">Share</button>
      <span class="pill">Words left: <span id="hudLeft">0</span></span>
      <span class="pill">Time: <span id="hudTimer">10:00</span></span>
      <span class="pill">Quickest: <span id="hudBest">--:--</span></span>
    </div>
  </div>

  <div id="hudWinners">
    <span class="pill pill-ghost">Top Player: <span id="hudTopPlayer">—</span></span>
    <span class="pill pill-ghost">Top Team: <span id="hudTopTeam">—</span></span>
  </div>

  <div class="row" style="margin-top:10px">
    <!-- Left: Board + Leaderboards -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">Puzzle</div>
      </div>
      <div class="card-content">
        <div style="margin-top:0;font-weight:900">Leaderboard</div>
        <div class="leader" id="leader"></div>

        <div style="margin-top:12px;font-weight:900">Teams</div>
        <div id="teamList" class="stack"></div>

        <div style="margin-top:12px;font-weight:900">Players</div>
        <div id="playerList" class="stack"></div>

        <div class="grid-wrap" style="margin-top:12px">
          <div id="grid" class="grid"></div>
        </div>
      </div>
    </div>

    <!-- Right: Final phrase & list -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">Info Panel</div>
      </div>
      <div class="card-content">
        <div style="margin-bottom:16px;">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div style="font-weight:900;">Final Phrase</div>
            <button class="btn btn-primary" id="btnClaimFinal" disabled>Claim Final Phrase</button>
          </div>
          <div style="font-weight:900;margin-top:8px">Letter Bank</div>
          <div id="bank" class="bank"></div>
          <div style="font-weight:900;margin:8px 0">Slots</div>
          <div id="slotsWrap" class="slots"></div>
          <div class="hint" style="margin-top:6px">The final phrase is hidden at start. Letter tiles unlock when words are found.</div>
        </div>

        <div style="margin-top:12px;font-weight:900">Words to Find</div>
        <ul id="wordList" class="list"></ul>
      </div>
    </div>
  </div>
</div>

<!-- Assign scoring modal -->
<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal">
    <div class="head">Assign Score</div>
    <div class="body">
      <div id="modalWord" style="font-weight:900;font-size:18px"></div>
      <label for="modalPlayer">Assign to player</label>
      <select id="modalPlayer" class="input"></select>
    </div>
    <div class="foot">
      <button class="btn" id="modalCancel">Cancel</button>
      <button class="btn btn-primary" id="modalAssign">Assign</button>
    </div>
  </div>
</div>

<!-- QR generator -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
/* ========================
   Config / Data
   ======================== */
const GRID_SIZE = 15;

// Word list (original + team set)
const WORD_BANK = [
  {word:"CORE",         hint:"Backbone of the network layer that sits beyond access."},
  {word:"SITETRACKER",  hint:"Deployment tool used for projects, milestones and dashboards."},
  {word:"ALLOCATION",   hint:"Assigning responsibilities or resources to a task."},
  {word:"NCT",          hint:"System used by all regions to allocate sites to INOC (abbr.)."},
  {word:"DELIVERY",     hint:"Phase where circuits are provisioned and a site is handed over."},
  {word:"LCA",          hint:"Team responsible for pre-build before go-live (abbr.)."},
  {word:"CRQ",          hint:"Formal change request code used in go-live processes (abbr.)."},
  {word:"AUDIT",        hint:"Action to ensure accurate site data before deployment."},
  {word:"TESTING",      hint:"Verifying a new configuration/service behaves as expected."},
  {word:"ESCALATION",   hint:"Raising a fault/issue to higher-level support or management."},
  {word:"ACHIEVEMENT",  hint:"Successful delivery milestone."},
  {word:"METRIC",       hint:"Performance indicator for rollout speed, faults, or uptime."},
  {word:"TEAM",         hint:"Group working together toward delivery goals."}
];

// Hidden final phrase — slots are empty initially
const TARGET_PHRASE = "CSANDLCATEAM";

/* ========================
   State
   ======================== */
const $ = id => document.getElementById(id);
let board = []; // 15x15 letters
let placedWords = []; // placed words and their cells
let selection = {active:false,start:null,end:null,cells:[]};
let players = []; // {id,name,teamId,score}
let teams = [];   // {id,name,color,score}
let bankLetters = []; // letters unlocked as words are found (scrambled)
let slotLetters = Array.from(TARGET_PHRASE, ch => ch===' ' ? ' ' : ''); // empty at start
let foundWordPending = null; // found word awaiting assignment
let finalSolved = null; // final phrase result

// Timer & records
let gameTimer = null;
let timeRemaining = 600; // 10:00
let bestTimeSeconds = null;
let roundActive = false;

// Seed for deterministic layout across players
let seed = getSeedFromURL() ?? makeSeed();
setSeedInURL(seed);

/* ========================
   RNG utils
   ======================== */
function makeSeed(){ return Math.random().toString(36).slice(2,10); }
function getSeedFromURL(){
  try{ const u = new URL(location.href); return u.searchParams.get("seed"); }catch(e){ return null; }
}
function setSeedInURL(s){
  try{
    const u = new URL(location.href); u.searchParams.set("seed", s);
    history.replaceState(null, "", u.toString());
  }catch(e){}
  $("subtitleSeed").textContent = `Multiplayer • 15×15 grid • Seed: ${s}`;
}
function sfc32(a,b,c,d){return function(){a|=0;b|=0;c|=0;d|=0;var t=(a+b|0)+(d|0)|0;d=d+1|0;a=b^b>>>9;b=c+(c<<3)|0;c=(c<<21|c>>>11);c=c+t|0;return (t>>>0)/4294967296;}}
function xmur3(str){for(var i=0,h=1779033703^str.length;i<str.length;i++){h=Math.imul(h^str.charCodeAt(i),3432918353);h=h<<13|h>>>19;}h=Math.imul(h^h>>>16,2246822507);h=Math.imul(h^h>>>13,3266489909);return function(){h=Math.imul(h^h>>>16,2246822507);h=Math.imul(h^h>>>13,3266489909);return (h^h>>>16)>>>0;}}
let rng = seeded(seed);
function seeded(s){ const seedFn = xmur3(s); return sfc32(seedFn(), seedFn(), seedFn(), seedFn()); }
function rand(n){ return Math.floor(rng()*n); }
function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=rand(i+1); [a[i],a[j]]=[a[j],a[i]];} return a; }
function arraysEqual(a,b){return a.length===b.length && a.every((v,i)=>v.r===b[i].r && v.c===b[i].c);}
function fmtTime(sec){ const m=String(Math.floor(sec/60)).padStart(2,'0'); const s=String(sec%60).padStart(2,'0'); return `${m}:${s}`; }

/* ========================
   Board generation
   ======================== */
function newBoard(){
  rng = seeded(seed); // reset RNG to the seed
  board = Array.from({length:GRID_SIZE}, ()=>Array.from({length:GRID_SIZE}, ()=>({letter:'',found:false,teamId:null})));
  placedWords = [];

  // place words longest-first
  const words=[...WORD_BANK].map(w=>w.word).sort((a,b)=>b.length-a.length);
  words.forEach(w=>placeWord(w));

  // fill randoms
  for(let r=0;r<GRID_SIZE;r++){
    for(let c=0;c<GRID_SIZE;c++){
      if(!board[r][c].letter) board[r][c].letter = String.fromCharCode(65+rand(26));
    }
  }
  renderBoard(); renderWords(); updateHUD();
}

function placeWord(word){
  const dirs = [[0,1],[1,0],[1,1],[1,-1],[0,-1],[-1,0],[-1,-1],[-1,1]];
  for(let attempt=0;attempt<1600;attempt++){
    const [dr,dc]=dirs[rand(dirs.length)];
    const r0=rand(GRID_SIZE), c0=rand(GRID_SIZE);
    const cells=[]; let ok=true;
    for(let i=0;i<word.length;i++){
      const r=r0+dr*i, c=c0+dc*i;
      if(r<0||c<0||r>=GRID_SIZE||c>=GRID_SIZE){ok=false;break;}
      const cell=board[r][c];
      if(cell.letter && cell.letter!==word[i]){ok=false;break;}
      cells.push({r,c});
    }
    if(ok){
      cells.forEach((p,i)=>board[p.r][p.c].letter=word[i]);
      placedWords.push({word,cells,foundByPlayerId:null,foundByTeamId:null});
      return true;
    }
  }
  return false;
}

/* ========================
   Rendering
   ======================== */
function renderBoard(){
  const g = $("grid");
  g.style.gridTemplateColumns = `repeat(${GRID_SIZE}, 44px)`;
  g.innerHTML = "";
  for(let r=0;r<GRID_SIZE;r++){
    for(let c=0;c<GRID_SIZE;c++){
      const d=document.createElement("div");
      d.className="cell"+(r===0?" top":"");
      d.dataset.r=r; d.dataset.c=c;
      d.textContent=board[r][c].letter;
      if(board[r][c].found) d.classList.add("found");
      g.appendChild(d);
    }
  }
}

function renderWords(){
  const ul = $("wordList"); ul.innerHTML="";
  const sorted=[...placedWords].sort((a,b)=>{const af=!!a.foundByPlayerId, bf=!!b.foundByPlayerId; if(af!==bf) return af?1:-1; return a.word.localeCompare(b.word);});
  sorted.forEach(w=>{
    const li=document.createElement("li");
    if(w.foundByPlayerId) li.classList.add("found");
    const left=document.createElement("div");
    const right=document.createElement("div");
    const info=WORD_BANK.find(x=>x.word===w.word);
    left.innerHTML=`<div style="font-weight:900">${w.word}</div><div class="hint">${info?.hint||""}</div>`;
    right.innerHTML=`<span class="badge ${w.foundByPlayerId?'found':'hidden'}">${w.foundByPlayerId?'Found':'Hidden'}</span>`;
    li.appendChild(left); li.appendChild(right);
    ul.appendChild(li);
  });
}

function renderPlayers(){
  const c=$("playerList"); c.innerHTML="";
  players.forEach(p=>{
    const row=document.createElement("div"); row.className="leader-row";
    const team=teams.find(t=>t.id===p.teamId);
    row.innerHTML=`<div>${p.name||'Unnamed Player'} <span style="color:${team?.color||'#9aa0a6'}">${team?.name||'No Team'}</span></div><div>${p.score}</div>`;
    c.appendChild(row);
  });
}

function renderTeams(){
  const c=$("teamList"); c.innerHTML="";
  teams.forEach(t=>{
    const row=document.createElement("div"); row.className="leader-row";
    row.innerHTML=`<div><span style="display:inline-block;width:10px;height:10px;background:${t.color};border-radius:999px;margin-right:8px"></span>${t.name||'Unnamed Team'}</div><div>${t.score}</div>`;
    c.appendChild(row);
  });
}

function renderLeader(){
  const L=$("leader"); L.innerHTML="";
  const ranking=[...players].sort((a,b)=>b.score-a.score);

  if(ranking.length>0){
    const lead=document.createElement("div"); lead.className="leader-row";
    const topP=ranking[0]; const topT=teams.find(t=>t.id===topP.teamId);
    lead.innerHTML=`<div>🏆 Leader: ${topP.name||'Unnamed Player'} — ${topT?.name||'No Team'}</div><div>${topP.score}</div>`;
    L.appendChild(lead);
  }else{
    const none=document.createElement("div"); none.className="leader-row";
    none.innerHTML=`<div>No teams yet 🏆</div><div>0</div>`; L.appendChild(none);
  }

  ranking.forEach((p,i)=>{
    const row=document.createElement("div"); row.className="leader-row";
    const team=teams.find(t=>t.id===p.teamId);
    row.innerHTML=`<div><strong>${i+1}.</strong> ${p.name||'Unnamed Player'} — ${team?.name||'No Team'}</div><div>${p.score}</div>`;
    L.appendChild(row);
  });

  // HUD winners
  const topP=ranking[0];
  $("hudTopPlayer").textContent = topP ? `${topP.name} (${topP.score})` : "—";
  const topTeamOverall = teams.length ? [...teams].sort((a,b)=>b.score-a.score)[0] : null;
  $("hudTopTeam").textContent = topTeamOverall ? `${topTeamOverall.name} (${topTeamOverall.score})` : "—";
}

function updateHUD(){
  $("hudLeft").textContent = placedWords.filter(w=>!w.foundByPlayerId).length;
  $("hudTimer").textContent = fmtTime(timeRemaining);
  $("hudBest").textContent = bestTimeSeconds==null ? "--:--" : fmtTime(bestTimeSeconds);
}

/* ========================
   Drag-to-select (grid)
   ======================== */
function cellAt(ev){
  const t=ev.target.closest(".cell"); if(!t) return null;
  return {r:+t.dataset.r,c:+t.dataset.c,el:t};
}
function cellEl(r,c){ return document.querySelector(`.cell[data-r="${r}"][data-c="${c}"]`); }
function lineCells(sr,sc,er,ec){
  const dr=Math.sign(er-sr), dc=Math.sign(ec-sc);
  // straight lines or perfect diagonals only
  if(!(dr===0||dc===0||Math.abs(er-sr)===Math.abs(ec-sc))) return [];
  const len=Math.max(Math.abs(er-sr),Math.abs(ec-sc))+1;
  const cells=[]; for(let i=0;i<len;i++) cells.push({r:sr+i*dr,c:sc+i*dc});
  return cells;
}
let selecting=false, startPos=null;

function startSelection(ev){
  const p=cellAt(ev); if(!p) return;
  selecting=true; startPos=p; selection.cells=[{r:p.r,c:p.c}];
  highlightSelection();
}
function moveSelection(ev){
  if(!selecting) return;
  const p=cellAt(ev); if(!p) return;
  selection.cells=lineCells(startPos.r,startPos.c,p.r,p.c);
  highlightSelection();
}
function endSelection(){
  if(!selecting) return;
  selecting=false;
  const letters=selection.cells.map(p=>board[p.r][p.c].letter).join("");
  const rev=letters.split("").reverse().join("");
  const match=placedWords.find(w=>!w.foundByPlayerId && (w.word===letters || w.word===rev || arraysEqual(selection.cells,w.cells) || arraysEqual(selection.cells.slice().reverse(), w.cells)));
  if(match){
    flashSelection("hit");
    setTimeout(()=>{ foundWordPending = match; openWordModal(match.word); }, 420);
  }else{
    flashSelection("miss");
  }
  document.querySelectorAll(".cell.sel").forEach(el=>el.classList.remove("sel"));
  selection={active:false,start:null,end:null,cells:[]};
}
function highlightSelection(){ document.querySelectorAll(".cell.sel").forEach(el=>el.classList.remove("sel")); selection.cells.forEach(p=>cellEl(p.r,p.c)?.classList.add("sel")); }
function flashSelection(kind){ selection.cells.forEach(p=>{const el=cellEl(p.r,p.c); el.classList.add(kind); setTimeout(()=>el.classList.remove(kind),420);}); }

/* ========================
   Modal / scoring
   ======================== */
function openWordModal(word){
  if(players.length===0){ alert("Add at least one player first to assign the score."); return; }
  $("modalWord").textContent = "WORD: "+word;
  const sel=$("modalPlayer"); sel.innerHTML="";
  players.forEach(p=>{
    const opt=document.createElement("option");
    const team=teams.find(t=>t.id===p.teamId);
    opt.value=p.id; opt.textContent=`${p.name||'Unnamed Player'} (${team?.name||'No Team'})`;
    sel.appendChild(opt);
  });
  $("modalBackdrop").style.display="flex";
  $("modalAssign").onclick = assignPendingWord;
}
function closeModal(){ $("modalBackdrop").style.display="none"; }
$("modalCancel").onclick = closeModal;

function assignPendingWord(){
  if(!foundWordPending) return closeModal();
  const playerId = $("modalPlayer").value || null;
  const teamId = players.find(p=>p.id===playerId)?.teamId ?? null;

  // mark + score
  foundWordPending.cells.forEach(({r,c})=>{ board[r][c].found=true; board[r][c].teamId=teamId; });
  foundWordPending.foundByPlayerId = playerId;
  foundWordPending.foundByTeamId = teamId;

  const pts = foundWordPending.word.length;
  const player = players.find(p=>p.id===playerId); if(player) player.score += pts;
  const team = teams.find(t=>t.id===teamId); if(team) team.score += pts;

  // unlock one letter into bank (first letter of the word)
  const ch = foundWordPending.word[0];
  bankLetters.push(ch); shuffle(bankLetters);

  foundWordPending = null;

  renderBoard(); renderWords(); renderPlayers(); renderTeams(); renderLeader();
  renderLetterBank(); updateClaimButton(); updateHUD();
  closeModal();
  checkGameStatus();
}

/* ========================
   Final phrase (drag/drop)
   ======================== */
function renderLetterBank(){
  const bank = $("bank"); bank.innerHTML="";
  bankLetters.forEach((ch,i)=>{
    const d=document.createElement("div");
    d.className="chip"; d.draggable=true; d.textContent=ch;
    d.addEventListener("dragstart", e=>{ e.dataTransfer.setData("text/plain","bank:"+i); });
    bank.appendChild(d);
  });
}
function renderSlots(){
  const wrap=$("slotsWrap"); wrap.innerHTML="";
  Array.from(TARGET_PHRASE).forEach((ch,i)=>{
    const slot=document.createElement("div");
    slot.className="slot"+(slotLetters[i]?" fill":"");
    slot.dataset.index=i;
    slot.textContent=slotLetters[i]||"";
    slot.addEventListener("dragover", e=>e.preventDefault());
    slot.addEventListener("drop", e=>{
      e.preventDefault();
      const data=e.dataTransfer.getData("text/plain"); if(!data) return;
      if(data.startsWith("bank:")){
        const idx=+data.split(":")[1]; const ch=bankLetters[idx]; if(!ch) return;
        slotLetters[i]=ch; bankLetters.splice(idx,1);
        renderSlots(); renderLetterBank(); updateClaimButton();
      }else if(data.startsWith("slot:")){
        const from=+data.split(":")[1];
        const tmp=slotLetters[from]; slotLetters[from]=slotLetters[i]; slotLetters[i]=tmp;
        renderSlots(); updateClaimButton();
      }
    });
    slot.draggable=!!slotLetters[i];
    slot.addEventListener("dragstart", e=>{ e.dataTransfer.setData("text/plain","slot:"+i); });
    wrap.appendChild(slot);
  });
}
function updateClaimButton(){
  const haveAll = slotLetters.length===TARGET_PHRASE.length && slotLetters.every((ch,i)=>!!ch || TARGET_PHRASE[i]===' ');
  $("btnClaimFinal").disabled = !haveAll || !!finalSolved;
}

$("btnClaimFinal").onclick = ()=>{
  if(finalSolved) return;

  // flash correctness on slots
  const slots=document.querySelectorAll("#slotsWrap .slot");
  slots.forEach((s,i)=>{
    const correct=TARGET_PHRASE[i];
    const val=slotLetters[i];
    if(val===correct){ s.classList.add("hit"); setTimeout(()=>s.classList.remove("hit"),420); }
    else{ s.classList.add("miss"); setTimeout(()=>s.classList.remove("miss"),420); }
  });

  setTimeout(()=>{
    if(players.length===0){ alert("Add at least one player first to assign the score."); return; }
    $("modalWord").textContent = `FINAL PHRASE`;
    const sel=$("modalPlayer"); sel.innerHTML="";
    players.forEach(p=>{
      const opt=document.createElement("option");
      const team=teams.find(t=>t.id===p.teamId);
      opt.value=p.id; opt.textContent=`${p.name||'Unnamed Player'} (${team?.name||'No Team'})`;
      sel.appendChild(opt);
    });
    $("modalBackdrop").style.display="flex";
    const orig=$("modalAssign").onclick;
    $("modalAssign").onclick=()=>{
      const attempt=slotLetters.join("");
      const ok = attempt===TARGET_PHRASE;
      const playerId = $("modalPlayer").value || null;
      const teamId = players.find(p=>p.id===playerId)?.teamId ?? null;
      if(ok){
        finalSolved={byPlayerId:playerId, byTeamId:teamId};
        const player=players.find(p=>p.id===playerId); if(player) player.score += 20;
        const team=teams.find(t=>t.id===teamId); if(team) team.score += 20;
        $("slotsWrap").classList.add("correct");
      }else{
        $("slotsWrap").classList.add("wrong");
        setTimeout(()=>$("slotsWrap").classList.remove("wrong"), 600);
      }
      renderPlayers(); renderTeams(); renderLeader();
      updateClaimButton();
      closeModal();
      $("modalAssign").onclick=orig;
      checkGameStatus();
    };
    $("modalCancel").onclick=()=>{ closeModal(); $("modalAssign").onclick=orig; };
  }, 420);
};

/* ========================
   Players & Teams
   ======================== */
function uid(){ return Math.random().toString(36).slice(2,9); }
function addTeam(){
  const name=prompt("Team name:"); if(!name) return;
  const color=prompt("Team colour (hex or name):", "#"+Math.random().toString(16).slice(2,8));
  teams.push({id:uid(), name, color: color||"#E60000", score:0});
  renderTeams(); renderLeader();
}
function addPlayer(){
  const name=prompt("Player name:"); if(!name) return;
  const teamId=null; // can be unassigned
  players.push({id:uid(), name, teamId, score:0});
  renderPlayers(); renderLeader();
}

/* ========================
   Timer / Controls
   ======================== */
function startTimer(){
  clearInterval(gameTimer);
  timeRemaining=600; roundActive=true; updateHUD();
  gameTimer=setInterval(()=>{
    timeRemaining--;
    $("hudTimer").textContent=fmtTime(timeRemaining);
    if(timeRemaining<=0){
      clearInterval(gameTimer); roundActive=false; alert("⏱ Time's up!");
    }
  },1000);
}
function stopTimer(){
  if(!roundActive) return;
  clearInterval(gameTimer); roundActive=false;
  if(allObjectivesDone()){
    maybeRecordBest(timeRemaining);
    alert(`🛑 Stopped. Time to finish: ${fmtTime(600 - timeRemaining)}. Best: ${$("hudBest").textContent}`);
  }else{
    alert("🛑 Stopped. Round not finished yet.");
  }
}
function resetRound(){
  $("winnerBanner").style.display="none";
  clearInterval(gameTimer); roundActive=false; timeRemaining=600;

  // reset state (keep best time)
  bankLetters=[];
  slotLetters = Array.from(TARGET_PHRASE, ch => ch===' ' ? ' ' : '');
  finalSolved=null;
  players.forEach(p=>p.score=0);
  teams.forEach(t=>t.score=0);

  newBoard();
  renderLetterBank(); renderSlots();
  renderPlayers(); renderTeams(); renderLeader(); renderWords();
  updateHUD(); updateClaimButton();
}
function maybeRecordBest(remain){
  const elapsed=600-remain;
  if(bestTimeSeconds==null || elapsed<bestTimeSeconds){
    bestTimeSeconds=elapsed;
    $("hudBest").textContent=fmtTime(bestTimeSeconds);
  }
}

/* ========================
   Finish detection
   ======================== */
function allObjectivesDone(){
  return placedWords.every(w=>!!w.foundByPlayerId) && !!finalSolved;
}
function checkGameStatus(){
  if(allObjectivesDone()){
    clearInterval(gameTimer); roundActive=false; maybeRecordBest(timeRemaining);
    const topPlayer=[...players].sort((a,b)=>b.score-a.score)[0];
    const topTeam=[...teams].sort((a,b)=>b.score-a.score)[0];
    const banner=$("winnerBanner");
    banner.style.display="block";
    banner.textContent = `🏁 Finished in ${fmtTime(600 - timeRemaining)} — Player: ${topPlayer?.name||'n/a'} (${topPlayer?.score||0}) • Team: ${topTeam?.name||'n/a'} (${topTeam?.score||0})`;
    alert(`🏁 Finished in ${fmtTime(600 - timeRemaining)}
Top Player: ${topPlayer?.name||'n/a'} (${topPlayer?.score||0})
Top Team: ${topTeam?.name||'n/a'} (${topTeam?.score||0})`);
  }
}

/* ========================
   QR + Share
   ======================== */
function initQR(){
  // Keep target static so scanners always succeed (your GitHub Pages root):
  const targetURL = "https://saturncapricornsquid.github.io/CSANDLCA/";
  const el = $("qrcode"); if(!el) return;
  el.innerHTML="";
  new QRCode(el, {
    text: targetURL,
    width: 110,
    height: 110,
    colorDark : "#E60000",
    colorLight : "#ffffff",
    correctLevel : QRCode.CorrectLevel.H
  });
}
$("btnShare")?.addEventListener("click", async ()=>{
  const url = new URL(location.href);
  try{
    await navigator.clipboard.writeText(url.toString());
    alert("Link copied to clipboard:\n"+url.toString());
  }catch(e){
    prompt("Copy this link:", url.toString());
  }
});

/* ========================
   Wiring & Boot
   ======================== */
$("btnNewTeam").onclick = addTeam;
$("btnNewPlayer").onclick = addPlayer;

$("btnShuffle").onclick = ()=>{
  seed = makeSeed();            // new shared seed
  setSeedInURL(seed);           // updates the URL query param
  resetRound();                 // rebuilds board with new seed
};

$("btnStart").onclick = ()=> startTimer();
$("btnStop").onclick  = ()=> stopTimer();
$("btnReset").onclick = ()=> resetRound();

// Mouse + touch drag-to-select
$("grid").addEventListener("mousedown", startSelection);
$("grid").addEventListener("mousemove", moveSelection);
window.addEventListener("mouseup", endSelection);

$("grid").addEventListener("touchstart", e=>{ e.preventDefault(); startSelection(e.touches[0]); }, {passive:false});
$("grid").addEventListener("touchmove",  e=>{ e.preventDefault(); moveSelection(e.touches[0]);  }, {passive:false});
window.addEventListener("touchend", endSelection);

// Final phrase UI init
function initFinal(){
  slotLetters = Array.from(TARGET_PHRASE, ch => ch===' ' ? ' ' : '');
  bankLetters = [];
  renderLetterBank(); renderSlots(); updateClaimButton();
}

// Boot
function boot(){
  initQR();
  initFinal();
  newBoard();
  renderPlayers(); renderTeams(); renderLeader();
  updateHUD(); updateClaimButton();
}
boot();
</script>

</body>
</html>
